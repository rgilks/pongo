---
alwaysApply: true
---

## Principles

- Keep changes small and test each step.
- Refactor for clarity: simple, elegant, maintainable.
- Improve tests and docs continuously.
- Remove dead or commented-out code.
- Use whitespace for readability.
- Keep functions < 20 lines; files < 200 lines.

## Technology preferences

- Prefer WebGPU via `wgpu` v24.0; avoid WebGL2 fallbacks.
- Prefer Node for servers/tooling; never use Python.

## Logging

- Ensure logs are sufficient for debugging and monitoring.

## Testing

- Maintain a `TEST-PLAN.md` document with a set of manual tests that you will run by automating the web browser this is in place of puppeteer or playwright tests.

## Pre-commit and push

**Required workflow for each iteration:**

1. **Fix linting errors and run tests** (automated)

   - Run `npm run test:all` to run all checks (format, check, clippy, tests)
   - To format code: `npm run fmt`
   - To run individual checks: `npm run fmt`, `npm run clippy`, `npm run test`

2. **Local testing (TEST-PLAN.md)**

   **Setup:**

   - Run `npm run start` to build and start local dev server (runs at http://localhost:8787)
   - Or separately: `npm run build` then `npm run dev`
   - Uses Miniflare to simulate Cloudflare Workers and Durable Objects locally

   **Testing steps:**

   - Follow `TEST-PLAN.md` for manual/local testing procedures
   - Test relevant endpoints locally: `/`, `/create`, `/join/:code`
   - Test WebSocket connections (work locally via Miniflare)
   - Verify rendering and game functionality in browser
   - Test entity rendering (paddles, ball)
   - Test controls: Up/Down arrow keys or W/S (desktop), touch buttons (mobile)

   **Benefits of local testing:**

   - No rate limits - unlimited testing
   - Faster iteration - no deployment needed
   - Better debugging - see logs in terminal
   - Isolated from production

   **Troubleshooting:**

   - If server won't start: ensure `npm run build` completed successfully
   - If port 8787 in use: kill process or use `--port` flag
   - To reset state: delete `.wrangler/state/` directory
   - Check terminal for detailed error messages

3. **Deploy, test, and check logs** (automated)

   - Run `npm run deploy:test` to deploy, test endpoints, and check logs automatically
   - Or manually:
     - Run `npx wrangler deploy` to deploy to production
     - Test deployed endpoints: `/`, `/create`, `/join/:code`
     - Run `npm run logs:check` to check for errors in logs
   - Verify all endpoints work correctly
   - Test WebSocket connections if applicable

4. **Documentation updates**

   - Update `README.md`, `TEST-PLAN.md` and `SPEC.md` if needed
   - Document any new features or changes

5. **Commit and push**
   - Only commit and push after all above steps succeed
   - Use descriptive commit messages
